- hosts: all

  vars:
    epelReleaseMajorVersion: 7

  tasks:
    - name: add epel repo
      yum_repository:
        name: epel_repo
        description: EPEL YUM repo
        baseurl:  http://dl.fedoraproject.org/pub/epel/{{epelReleaseMajorVersion}}/x86_64/
        gpgcheck: yes
        gpgkey: https://dl.fedoraproject.org/pub/epel/RPM-GPG-KEY-EPEL-7
        enabled: yes

    - name: ensure git, python 3.6, development tools and nginx are installed
      yum:
        name: "{{ packages }}"
      vars:
        packages:
          - git
          - python36
          - wget
          - gcc
          - make
          - nginx

    - name: enable service nginx and ensure it is not masked
      systemd:
        name: nginx
        enabled: yes
        masked: no

    # TODO install firewalld and open port 8000

    - name: ensure latest version of nss, curl and libcurl are installed
      yum:
        name: "{{ packages }}"
        state: latest
        update_cache: true
      become: true
      vars:
        packages:
          - nss
          - curl
          - libcurl

    - name: Copy script to update sqlite3 to 3.29 (Django 2.2 requires 3.8.3+)
      copy: 
        src: update_sqlite3.sh
        dest: /home/{{ ansible_ssh_user }}/
        mode: 0700
        owner: "{{ ansible_ssh_user }}"

    - name: Execute the script
      shell: /home/{{ ansible_ssh_user }}/update_sqlite3.sh {{ ansible_ssh_user }}
      become_user: "{{ ansible_ssh_user }}"
      register: out

    - debug: var=out.stdout_lines

    - name: Remove the script to update sqlite3
      file:
        path: /home/{{ ansible_ssh_user }}/update_sqlite3.sh
        state: absent

    - name: set selinux flags
      seboolean:
        name: httpd_can_network_connect
        state: yes
        persistent: yes

    - name: create serving directory
      file:
        path: /home/{{ ansible_ssh_user }}/budgeteer/static
        state: directory
        mode: 0755

    - name: set facl permissions
      acl:
        path: /home/{{ ansible_ssh_user }}/budgeteer/static
        entry: user:nginx:rwx
        state: present