{% extends 'base.html' %}
{% load budgets_tags %}
{% load humanize %}
{% load staticfiles %}

{% block title %}Budgeteer{% endblock %}

{% block content %}

<div class="row">
    <h3>General recap</h3>
</div>

<div class="row">
    <div  class="col">
      <h5>Last two months</h5>
      <div class="table-responsive-md table-sm">
        <table class="table" id="id_recap">
          <tr>
              <td>Starting balance</td>
              <td>{{ currency}} {{ starting_balance | intcomma }}</td>
          </tr>
          <tr>
              <td><b>Current balance</b></td>
              <td><b>{{ currency }} {{ current_balance | intcomma }}</b></td>
          </tr>
          <tr>
              <td>Result</td>
              {% if current_balance and starting_balance%}
                <td class="{% if two_months_diff < 0 %}text-danger{% else %}text-success{% endif %}">
                  {{ currency }}{% if two_months_diff > 0 %}+{% endif %}{{ two_months_diff | intcomma }}
                  ({% if two_months_diff <= 0 %}-{% else %}+{% endif %}{{ two_months_diff_perc }}%)
                </td>
              {% else %}
                -
              {% endif %}
          </tr>
        </table>
      </div>
    </div>
    {% if goals %}
      <div  class="col">
        <h5>Goals</h5>
        <div class="table-responsive-md table-sm">
          <table class="table" id="id_recap">
            <tr>
              <th>Goal</th>
              <th>Amount</th>
              <th>Months to go</th>
            </tr>
            {% for goal in goals %}
              <tr>
                <td>{{ goal.text }}</td>
                <td>{{ currency}} {{ goal.amount | intcomma }}</td>
                {% if goal.months_to_go is None %}
                  <td class="text-danger">Negative balance: N/A</td>
                {% elif goal.months_to_go > 0 %}
                  <td>{{ goal.months_to_go }}</td>
                {% else %}
                  <td class="text-success">Goal already achieved!</td>
                {% endif %}
              </tr>
            {% endfor %}
          </table>
        </div>
      </div>
    {% endif %}
</div>

{% if categories or income_categories%}
<div class="row">
  {% if categories %}
    <div class="col">
      <h5 id="id_current_month_date">Summary for {% now 'Y-m' %}</h5>
      <table class="table-responsive-md table-sm" id="id_expenses_total">
        <tr>
          <th>Category</th>
          <th>Spended amount</th>
          <th>Budgeted amount</th>
          <th>Status</th>
        </tr>
        {% for cat in categories %}
          {% if cat.total > 0 or cat.mb.amount %}
          <tr>
            <td>{{ cat.text }}</td>
            <td>{{ currency}} {{ cat.total | intcomma }}</td>
            <td>{{ cat.mb.amount|default:"No monthly budget for this month" }}</td>
            {% if cat.mb.amount and cat.total %}
            <td class="{% if cat.mb.amount|sub:cat.total < 0 %}text-danger{% else %}text-success{% endif %}">
              {{ currency}} {{ cat.mb.amount|sub:cat.total | intcomma }}
            </td>
            {% else %}
            <td> {{ "N/A" }} </td>
            {% endif %}
          </tr>
          {% endif %}
        {% endfor %}
      </table>
    </div>
    {% endif %}

  <div class="col">
    <!-- TODO: shorten this. Hide amount = 0 items? -->
    {% if income_categories %}
    <table class="table table-responsive-md table-sm" id="id_incomes_total">
      <tr>
        <th>Category</th>
        <th>Income amount</th>
      </tr>
      {% for inc in income_categories %}
      <!-- TODO: verify at least on category is more than 0-->
        <!-- {% if inc.total > 0 %} -->
        <tr>
          <td>{{ inc.text }}</td>
          <td>{{ currency}} {{ inc.total | intcomma }}</td>
        </tr>
        <!-- {% endif %} -->
      {% endfor %}
    </table>
    {% endif %}
  </div>
</div>
{% endif %}

<div class="row">
    {% if bar_graph %}
    <div  class="col">
      <img src="data:image/png;base64,{{ bar_graph }}" class="img-fluid" alt="Bar graph">
    </div>
    {% endif %}
    {% if pie_graph %}
      <div class="col">
        <img src="data:image/png;base64,{{ pie_graph }}" class="img-fluid" alt="Pie graph">
      </div>
    {% endif %}
</div>

<div class="row">
  {% if current_mb %}
    <div  class="col">
      <h6><b>Current</b> month situation</h6>
      <table class="table table-responsive-md table-sm" id="id_monthly_balances">
        <tr>
          <th>Category</th>
          <th>Amount</th>
        </tr>

        {% for monthly_balance in current_mb %}
          <tr>
            <td>{{ monthly_balance.category.text }}</td>
            <td>{{ currency}} 
              {% if monthly_balance.actual_amount %}
                  {{ monthly_balance.actual_amount | intcomma }}</td>
              {% else %}
                  {{ monthly_balance.ammount | intcomma }}</td>
              {% endif %}
          </tr>
        {% endfor %}

          <tr>
            <td><b>Total</b></td>
            <td><b>{{ currency}} {{ current_mb_total | intcomma }}</b></td>
          </tr>
      </table>
    </div>
  {% endif %}

  {% if prev_mb %}
  <div  class="col">
    <h6><b>Previous</b> month situation</h6>
    <table class="table table-responsive-md table-sm" id="id_monthly_balances">
      <tr>
        <th>Category</th>
        <th>Amount</th>
      </tr>

      {% for monthly_balance in prev_mb %}
        <tr>
          <td>{{ monthly_balance.category.text }}</td>
          <td>{{ currency}} 
            {% if monthly_balance.actual_amount %}
                {{ monthly_balance.actual_amount | intcomma }}</td>
            {% else %}
                {{ monthly_balance.amount | intcomma }}</td>
            {% endif %}
        </tr>
      {% endfor %}

        <tr>
          <td><b>Total</b></td>
          <td><b>{{ currency}} {{ prev_mb_total | intcomma }}</b></td>
        </tr>
    </table>
  </div>
  {% endif %}
</div>

{% endblock %}
